import React from 'react';
import { View, FlatList, StyleSheet, SafeAreaView, ActivityIndicator, Text } from 'react-native';
// Context Hook ê°€ì ¸ì˜¤ê¸°
import { useTranslation } from '../context/TranslationContext'; 
// useAudioRecorderëŠ” ì—¬ê¸°ì„œ import í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤! (Contextê°€ ê´€ë¦¬í•¨)

// [ì„ì‹œ] MicButtonê³¼ ChatMessage ì»´í¬ë„ŒíŠ¸ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ê°€ ë‚˜ë¯€ë¡œ,
// ì•„ë˜ ì£¼ì„ì„ í’€ê±°ë‚˜ í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
// ì§€ê¸ˆì€ ì—†ë‹¤ê³  ê°€ì •í•˜ê³  ê¸°ë³¸ View/Textë¡œ ëŒ€ì²´í•˜ëŠ” ì½”ë“œë¥¼ ë„£ì–´ë‘¡ë‹ˆë‹¤.
// import MicButton from '../components/MicButton';
// import ChatMessage from '../components/ChatMessage';
import { TouchableOpacity } from 'react-native'; // ì„ì‹œ ë²„íŠ¼ìš©

export default function TranslationScreen() {
    // Contextì—ì„œ í•„ìš”í•œ ëª¨ë“  ê²ƒì„ êº¼ë‚´ ì”ë‹ˆë‹¤.
    const { 
        messages,           // ì±„íŒ… ë°ì´í„°
        isLoading,          // ë¡œë”© ìƒíƒœ (API í˜¸ì¶œ ì¤‘)
        isRecording,        // ë…¹ìŒ ìƒíƒœ
        handleVoiceInput,   // ë§ˆì´í¬ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì‹¤í–‰ë  í•¨ìˆ˜
        handleSendMessage   // (í…ŒìŠ¤íŠ¸ìš©) í…ìŠ¤íŠ¸ ì „ì†¡ í•¨ìˆ˜
    } = useTranslation();

    // ----------------------------------------------------
    // ë Œë”ë§
    // ----------------------------------------------------
    return (
        <SafeAreaView style={styles.safeArea}>
            <View style={styles.container}>
                
                {/* 1. ëŒ€í™” ëª©ë¡ */}
                <FlatList
                    data={messages}
                    keyExtractor={item => item.id}
                    // ìŠ¤í¬ë¡¤ì´ ìë™ìœ¼ë¡œ ì•„ë˜ë¡œ ê°€ê²Œ í•˜ë ¤ë©´ ì´ ì†ì„± í™œìš©
                    onContentSizeChange={() => this.flatList.scrollToEnd({ animated: true })}
                    ref={ref => this.flatList = ref}
                    
                    renderItem={({ item }) => (
                        // ChatMessage ì»´í¬ë„ŒíŠ¸ê°€ ìˆë‹¤ë©´ êµì²´í•˜ì„¸ìš”.
                        // <ChatMessage ... />
                        <View style={[
                            styles.messageBubble, 
                            item.isUser ? styles.myMessage : styles.otherMessage
                        ]}>
                            <Text style={styles.messageText}>{item.text}</Text>
                            <Text style={styles.timeText}>
                                {new Date(item.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </Text>
                        </View>
                    )}
                    contentContainerStyle={styles.chatList}
                />

                {/* 2. ë¡œë”©/ë…¹ìŒ ìƒíƒœ í‘œì‹œ (ì˜¤ë²„ë ˆì´) */}
                {(isLoading || isRecording) && (
                    <View style={styles.loadingOverlay}>
                        {isLoading && <ActivityIndicator size="large" color="#007AFF" />}
                        {isRecording && <Text style={styles.recordingText}>ğŸ¤ ë“£ê³  ìˆì–´ìš”...</Text>}
                    </View>
                )}

                {/* 3. ë§ˆì´í¬ ë²„íŠ¼ ì˜ì—­ */}
                <View style={styles.buttonContainer}>
                    {/* MicButton ì»´í¬ë„ŒíŠ¸ ëŒ€ì‹  ì„ì‹œ ë²„íŠ¼ */}
                    <TouchableOpacity 
                        style={[
                            styles.micButton, 
                            isRecording && styles.micButtonRecording // ë…¹ìŒ ì¤‘ì´ë©´ ë¹¨ê°„ìƒ‰
                        ]} 
                        onPress={handleVoiceInput}
                    >
                        <Text style={styles.micIcon}>
                            {isRecording ? "â¹ï¸" : "ğŸ™ï¸"}
                        </Text>
                    </TouchableOpacity>
                </View>

            </View>
        </SafeAreaView>
    );
}

const styles = StyleSheet.create({
    safeArea: {
        flex: 1,
        backgroundColor: '#f5f5f5',
    },
    container: { 
        flex: 1,
    },
    chatList: { 
        paddingHorizontal: 15,
        paddingBottom: 100, // ë²„íŠ¼ ê³µê°„ í™•ë³´
        paddingTop: 20,
    },
    buttonContainer: {
        position: 'absolute',
        bottom: 30,
        alignSelf: 'center',
        alignItems: 'center',
        justifyContent: 'center',
    },
    micButton: {
        width: 70,
        height: 70,
        borderRadius: 35,
        backgroundColor: '#007AFF', // íŒŒë€ìƒ‰ (ëŒ€ê¸°)
        justifyContent: 'center',
        alignItems: 'center',
        elevation: 5,
        shadowColor: "#000",
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.25,
        shadowRadius: 3.84,
    },
    micButtonRecording: {
        backgroundColor: '#FF3B30', // ë¹¨ê°„ìƒ‰ (ë…¹ìŒ ì¤‘)
    },
    micIcon: {
        fontSize: 30,
        color: 'white',
    },
    loadingOverlay: {
        position: 'absolute',
        top: 20,
        alignSelf: 'center',
        backgroundColor: 'rgba(255,255,255,0.9)',
        padding: 10,
        borderRadius: 20,
        flexDirection: 'row',
        alignItems: 'center',
        zIndex: 10,
        elevation: 5,
    },
    recordingText: {
        fontSize: 16,
        fontWeight: 'bold',
        color: '#FF3B30',
        marginLeft: 10,
    },
    // [ì„ì‹œ ìŠ¤íƒ€ì¼] ChatMessage ì»´í¬ë„ŒíŠ¸ ì—†ì„ ë•Œìš©
    messageBubble: {
        maxWidth: '80%',
        padding: 12,
        borderRadius: 15,
        marginBottom: 10,
    },
    myMessage: {
        alignSelf: 'flex-end',
        backgroundColor: '#DCF8C6', // ì¹´í†¡ ë…¸ë€ìƒ‰ ëŠë‚Œ
    },
    otherMessage: {
        alignSelf: 'flex-start',
        backgroundColor: 'white',
        borderWidth: 1,
        borderColor: '#eee',
    },
    messageText: {
        fontSize: 16,
        color: '#333',
    },
    timeText: {
        fontSize: 10,
        color: '#888',
        marginTop: 5,
        alignSelf: 'flex-end',
    }
});
